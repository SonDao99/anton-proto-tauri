name: release-linux
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag"
        required: true
        type: string
  push:
    tags:
      - v*

env:
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || github.ref_name }}

jobs:
  publish-tauri-linux:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - uses: dtolnay/rust-toolchain@stable

      # Tauri v2 Linux prerequisites
      - name: Install Linux deps (Tauri v2)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            jq \
            gh

      - name: Install frontend deps
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Python sidecar (Linux)
        working-directory: src-python
        run: |
          python -m pip install --upgrade pip
          # Install dependencies and PyInstaller
          pip install -r requirements.txt pyinstaller==6.15.0
          # Build with main.spec which creates a single-file executable with all dependencies
          pyinstaller main.spec --noconfirm --clean
          # Copy the single-file executable to Tauri binaries directory
          mkdir -p ../src-tauri/binaries
          cp dist/main ../src-tauri/binaries/main
          chmod +x ../src-tauri/binaries/main

      - name: Finalize sidecar binary (rename + env)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
        run: node scripts/rename-sidecar.js

      - name: Verify .env file was created
        run: |
          echo "Checking for .env file in src-tauri/binaries/..."
          if [ -f "src-tauri/binaries/.env" ]; then
            echo "✓ .env file exists"
            echo "Contents (secrets masked):"
            cat src-tauri/binaries/.env | sed 's/=.*/=***MASKED***/'
          else
            echo "✗ ERROR: .env file NOT found!"
            echo "Listing src-tauri/binaries/:"
            ls -la src-tauri/binaries/
            exit 1
          fi

      # Override beforeBuildCommand to skip TS checks in CI (Vite only)
      - name: Create Tauri Linux config overlay
        run: |
          jq '.build.beforeBuildCommand="vite build"' src-tauri/tauri.conf.json > src-tauri/tauri.linux.json

      - name: Build and publish (AppImage)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
        with:
          tauriScript: npx tauri
          args: --config src-tauri/tauri.linux.json
          tagName: ${{ env.RELEASE_TAG }}
          releaseName: "AntonAI ${{ env.RELEASE_TAG }}"
          releaseDraft: true
          prerelease: false

      - name: Ensure release exists (manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "${RELEASE_TAG}" || gh release create "${RELEASE_TAG}" --draft -t "AntonAI ${RELEASE_TAG}"

      - name: Make stable-named AppImage copy
        run: |
          APPIMAGE="$(ls src-tauri/target/release/bundle/appimage/*.AppImage | head -n1)"
          cp "$APPIMAGE" "src-tauri/target/release/bundle/appimage/antonai-linux-x86_64.AppImage"

      - name: Upload stable-named asset to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${RELEASE_TAG}" \
            src-tauri/target/release/bundle/appimage/antonai-linux-x86_64.AppImage \
            --clobber
